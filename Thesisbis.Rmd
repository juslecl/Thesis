---
title: "Thesis : R"
author: "Justine Leclerc"
date: "2024-09-06"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(splines)
library(stats4)
library(VGAM)
library(openxlsx)
```

### Generating random data process.
```{r echo=FALSE}
set.seed(123)
#1) create a dataset with X following a normal but different patterns for the error.
datagen <- function(n, beta, rcdf, meanX, sdX, M=100) {
  d <- length(meanX)
  datasets <- vector("list", M)  # Create a list to store M datasets
  for (m in 1:M) {  # Loop over the number of replicates
    x <- matrix(data = NA, nrow = n, ncol = d)  # Design matrix
    for (j in 1:d)  x[,j] <- rnorm(n,mean=meanX[j],sd=sdX[j])
    eps <- rcdf(n)  # Generate epsilon
    y <- x%*%beta + eps  # Response variable
    datasets[[m]] <- list(Y = y, X = x, B = beta, E = eps)  # Store dataset in the list
}
  return(datasets)  # Return the list of datasets
}
```

### Formula for criterion
```{r echo=FALSE}
# Differentiable form
critbis <- function(beta, data, F_eps) {
  n <- length(data$Y)
  residuals <- data$Y - data$X%*%beta  # This gives a vector of length n
  F_eps_residuals <- F_eps(as.vector(residuals))  # Ensure itâ€™s a vector
  p2 <- mean(F_eps_residuals^2)
  p3 <- (1 / (n^2)) * sum(sapply(1:n, function(i) {
    sum(sapply(1:n, function(j) {
      if (i != j) {
        return(max(F_eps_residuals[i], F_eps_residuals[j]))
      } else {
        return(0)
      }
    }))
  }))
  p4 <- (1 / (n^2)) * sum(F_eps_residuals)
  result <- 1/3 + p2 - p3 - p4
  return(result)
}
```

### Gradient for the criterion.
```{r include=FALSE}
# Implement the gradient. Returns a vector in R^d and the corresponding L-2 norm.
grad <- function(data, beta, F_eps,f_eps) {
  n <- length(data$Y)
  d <- length(beta)
  residuals <- data$Y - data$X%*%beta
  f_residuals <- f_eps(residuals) #returns a nx1 matrix
  F_residuals <- F_eps(residuals) #returns a nx1 matrix
  term1_weights <- f_residuals * (1 - 2 * F_residuals) # returns a 1xn matrix.
  term1 <- (t(term1_weights)%*%data$X) / n #1xd matrix.
    term2 <- 0
  for (i in 1:n) {
    for (j in 1:n) {
      if (i != j) {
        r_i <- residuals[i]
        r_j <- residuals[j]
        indicator <- as.numeric(r_i > r_j)
        term2 <- term2 + indicator * (f_eps(r_i) * data$X[i,] - f_eps(r_j) * data$X[i,])
      }
    }
  }
  term2 <- term2 / n^2
  result <- term1 + term2
  norm <- sqrt(sum(result^2))
  return(list(G=result,N=norm)) #$G is 1xd matrix.
}
```

# Gradient descent algorithm.
```{r echo=FALSE}
# Function to build OLS.
ols <- function(data) {
  return(solve(t(data$X)%*%data$X)%*%t(data$X)%*%data$Y)
}

# Gradient with Backtracking Line Search
# Since the initial values are crucial for the performance of the algorithm, take as initial value classic OLS.
# Try to improve the speed 
backtracking<-function(data, cdf, pmf, tol = 1e-3, a = .001, b = .9,max_iteration = 1000){
  k = 1
  beta <- ols(data) #returns a 2x1 matrix.
  betaplus <- beta - a * t(grad(data, beta, cdf,pmf)$G/grad(data, beta, cdf,pmf)$N)
  while (sqrt(sum((beta - betaplus)^2)) > tol && k < max_iteration){
    a <- b * a
    beta <- betaplus
    betaplus <- beta - a * t(grad(data, beta, cdf,pmf)$G/grad(data, beta, cdf,pmf)$N)
    k <- k + 1
  }
  return(list(iteration = k - 1, res = betaplus, compa = cbind(data$B,betaplus,ols(data))))
}
```

### Simulations for || \beta^*-\beta_0||, || OLS-\beta_0||
```{r echo=FALSE}
# Create a function which returns as a list both || \beta^*-\beta_0|| and || OLS-\beta_0||.
normbeta <- function(data, F_eps, f_eps) {
  return(list(norm1=sqrt(sum((backtracking(data,F_eps, f_eps)$res-data$B)^2)),norm2=sqrt(sum((data$B-ols(data))^2))))
}
```



# Compute a Laplace MLE.
```{r}
library(optimx)

datplacexl <- datagen(500, c(3.75,1.6,0.3), rlaplace, c(5,3,-2), c(1.3,0.5,2), M=100)

# MLE algorithm.
# Define the negative log-likelihood function for Laplace-distributed errors
neg_lllaplace <- function(params, X, Y) {
  beta <- params # Extract regression coefficients (beta)
  b <- 1  # Extract the scale parameter (b)
  
  # Calculate residuals (errors) from the linear model
  residuals <- Y - X %*% beta
  
  # Negative log-likelihood for Laplace distribution
  n <- length(Y)
  neg_ll <- n * log(2 * b) + sum(abs(residuals) / b)
  
  return(neg_ll)
}

initial_params <- c(rep(0, ncol(datplacexl[[1]]$X)))
# Optimize the negative log-likelihood
fit <- optimx(par=initial_params, fn=neg_lllaplace, X=datplacexl[[1]]$X, Y=datplacexl[[1]]$Y, method="BFGS")

mledatplacexl <- lapply(datplacexl, function(data) optimx(par=initial_params, fn=neg_lllaplace, X=data$X, Y=data$Y, method="BFGS"))

mlelaplace <- matrix(rep(0,300),nrow=100)
for (i in 1:100){
  mlelaplace[i,] <-c(mledatplacexl[[i]]$p1,mledatplacexl[[i]]$p2,mledatplacexl[[i]]$p3)
}
mleplaplace

normmle <- apply(mlelaplace,1,function(data) sqrt(sum(data-c(3.75,1.6,0.3))^2))

neg_llcauchy <- function(params, X, Y) {
  beta <- params  # Extract regression coefficients (beta)
  gamma <- 1  # Scale parameter (gamma) - fixed here, but could be made a parameter to optimize
  
  # Calculate residuals (errors) from the linear model
  residuals <- Y - X %*% beta
  
  # Negative log-likelihood for Cauchy distribution
  n <- length(Y)
  neg_ll <- n * log(pi * gamma) + sum(log(1 + (residuals / gamma)^2))
  
  return(neg_ll)
}


#file_path <- "~/polybox - Justine Leclerc (jleclerc@student.ethz.ch)@polybox.ethz.ch (2)/THESIS !/res_simul.xlsx"
#wb <- wb <- loadWorkbook(file_path)
#addWorksheet(wb, "1002laplace")
#writeData(wb, sheet = "1002laplace", resnorm3)
#saveWorkbook(wb, file_path, overwrite = TRUE)
```

## Results to be added in xslx.
```{r}
# Create the vectors for norm1 and norm2
norm1 <- c(
  0.1126449, 0.1013052, 0.05804682, 0.1887437, 0.1236871, 
  0.1688896, 0.1001817, 0.06956194, 0.1841387, 0.1357772, 
  0.1459768, 0.1312891, 0.04743605, 0.06693616, 0.04198929, 
  0.1076877, 0.05565371, 0.175622, 0.1385516, 0.1319883, 
  0.1206915, 0.01612094, 0.1716022, 0.1618484, 0.1320103, 
  0.08758134, 0.07610974, 0.2009736, 0.07784379, 0.2603848, 
  0.04647959, 0.150249, 0.04701515, 0.05421286, 0.09407515, 
  0.2254334, 0.0782761, 0.01767894, 0.2448841, 0.1238304, 
  0.1063053, 0.04493895, 0.1481939, 0.116719, 0.2927528, 
  0.1369927, 0.1740786, 0.09237642, 0.08367116, 0.1209569, 
  0.197031, 0.1628209, 0.03874133, 0.03871919, 0.06296266, 
  0.1029053, 0.1414712, 0.2933447, 0.07637201, 0.2507689, 
  0.1764213, 0.05552743, 0.03419781, 0.08091307, 0.2496604, 
  0.07121973, 0.132254, 0.1451317, 0.1456854, 0.1647052, 
  0.1755443, 0.1137843, 0.2184908, 0.1181282, 0.1054346, 
  0.08452618, 0.1025931, 0.1612823, 0.2060619, 0.03849558, 
  0.0557289, 0.1648496, 0.06689275, 0.07291019, 0.170766, 
  0.06838274, 0.05714951, 0.1081027, 0.02411675, 0.0737204, 
  0.04752247, 0.2414163, 0.05553974, 0.1044559, 0.3139244, 
  0.1815362, 0.01272708, 0.01639146, 0.03837617, 0.1388173
)

norm2 <- c(
  0.1125881, 0.1013415, 0.05850918, 0.1890129, 0.1237098, 
  0.1690619, 0.09982069, 0.06973077, 0.1846532, 0.1357888, 
  0.14552, 0.130927, 0.04699695, 0.06705529, 0.04235549, 
  0.1077121, 0.05556027, 0.1757838, 0.1385763, 0.1319864, 
  0.1207628, 0.01612901, 0.1718022, 0.1618355, 0.132078, 
  0.08760411, 0.07623356, 0.2009679, 0.07799658, 0.2604927, 
  0.04643068, 0.150076, 0.04624933, 0.05457206, 0.09410305, 
  0.2254492, 0.07846398, 0.01828172, 0.245101, 0.1250593, 
  0.1063772, 0.04656114, 0.1483016, 0.1169198, 0.2930956, 
  0.1371249, 0.1742706, 0.09288181, 0.08475498, 0.1214229, 
  0.1970954, 0.1629542, 0.03943087, 0.03868081, 0.06138363, 
  0.1028961, 0.1415469, 0.2933823, 0.07681146, 0.2510178, 
  0.1764956, 0.05646961, 0.0341259, 0.08148241, 0.2501109, 
  0.07171382, 0.1321898, 0.1452014, 0.1458206, 0.1647534, 
  0.1756311, 0.1137503, 0.218721, 0.1185019, 0.105979, 
  0.08494127, 0.1026592, 0.1613542, 0.2063933, 0.04000764, 
  0.05607617, 0.1648078, 0.06682327, 0.07279169, 0.1708304, 
  0.06902123, 0.05721769, 0.1078056, 0.02488687, 0.07402485, 
  0.0474735, 0.2414633, 0.05601744, 0.1044826, 0.3141928, 
  0.1816075, 0.0134738, 0.01583272, 0.0388309, 0.1390271
)

library(openxlsx)
file_path <- "~/polybox - Justine Leclerc (jleclerc@student.ethz.ch)@polybox.ethz.ch (2)/THESIS !/res_simul.xlsx"
wb <- loadWorkbook(file_path)
addWorksheet(wb, "5005t")
writeData(wb, sheet = "5005t", results)
saveWorkbook(wb, file_path, overwrite = TRUE)

```

