
library(splines)
library(stats4)
library(VGAM)


### Generating random data process.

set.seed(123)
#1) create a dataset with X following a normal but different patterns for the error.
datagen <- function(n, beta, rcdf, meanX, sdX, M=100) {
  d <- length(meanX)
  datasets <- vector("list", M)  # Create a list to store M datasets
  for (m in 1:M) {  # Loop over the number of replicates
    x <- matrix(data = NA, nrow = n, ncol = d)  # Design matrix
    for (j in 1:d)  x[,j] <- rnorm(n,mean=meanX[j],sd=sdX[j])
    eps <- rcdf(n)  # Generate epsilon
    y <- x%*%beta + eps  # Response variable
    datasets[[m]] <- list(Y = y, X = x, B = beta, E = eps)  # Store dataset in the list
  }
  return(datasets)  # Return the list of datasets
}


### Formula for criterion

# Differentiable form
critbis <- function(beta, data, F_eps) {
  n <- length(data$Y)
  residuals <- data$Y - data$X%*%beta  # This gives a vector of length n
  F_eps_residuals <- F_eps(as.vector(residuals))  # Ensure itâ€™s a vector
  p2 <- mean(F_eps_residuals^2)
  p3 <- (1 / (n^2)) * sum(sapply(1:n, function(i) {
    sum(sapply(1:n, function(j) {
      if (i != j) {
        return(max(F_eps_residuals[i], F_eps_residuals[j]))
      } else {
        return(0)
      }
    }))
  }))
  p4 <- (1 / (n^2)) * sum(F_eps_residuals)
  result <- 1/3 + p2 - p3 - p4
  return(result)
}


### Gradient for the criterion.
{r include=FALSE}
# Implement the gradient. Returns a vector in R^d and the corresponding L-2 norm.
grad <- function(data, beta, F_eps,f_eps) {
  n <- length(data$Y)
  d <- length(beta)
  residuals <- data$Y - data$X%*%beta
  f_residuals <- f_eps(residuals) #returns a nx1 matrix
  F_residuals <- F_eps(residuals) #returns a nx1 matrix
  term1_weights <- f_residuals * (1 - 2 * F_residuals) # returns a 1xn matrix.
  term1 <- (t(term1_weights)%*%data$X) / n #1xd matrix.
  term2 <- 0
  for (i in 1:n) {
    for (j in 1:n) {
      if (i != j) {
        r_i <- residuals[i]
        r_j <- residuals[j]
        indicator <- as.numeric(r_i > r_j)
        term2 <- term2 + indicator * (f_eps(r_i) * data$X[i,] - f_eps(r_j) * data$X[i,])
      }
    }
  }
  term2 <- term2 / n^2
  result <- term1 + term2
  norm <- sqrt(sum(result^2))
  return(list(G=result,N=norm)) #$G is 1xd matrix.
}


# Gradient descent algorithm.

# Function to build OLS.
ols <- function(data) {
  return(solve(t(data$X)%*%data$X)%*%t(data$X)%*%data$Y)
}

# Gradient with Backtracking Line Search
# Since the initial values are crucial for the performance of the algorithm, take as initial value classic OLS.
# Try to improve the speed 
backtracking<-function(data, cdf, pmf, tol = 1e-3, a = .001, b = .9,max_iteration = 1000){
  k = 1
  beta <- ols(data) #returns a 2x1 matrix.
  betaplus <- beta - a * t(grad(data, beta, cdf,pmf)$G/grad(data, beta, cdf,pmf)$N)
  while (sqrt(sum((beta - betaplus)^2)) > tol && k < max_iteration){
    a <- b * a
    beta <- betaplus
    betaplus <- beta - a * t(grad(data, beta, cdf,pmf)$G/grad(data, beta, cdf,pmf)$N)
    k <- k + 1
  }
  return(list(iteration = k - 1, res = betaplus, compa = cbind(data$B,betaplus,ols(data))))
}


### Simulations for || \beta^*-\beta_0||, || OLS-\beta_0||

# Create a function which returns as a list both || \beta^*-\beta_0|| and || OLS-\beta_0||.
normbeta <- function(data, F_eps, f_eps) {
  return(list(norm1=sqrt(sum((backtracking(data,F_eps, f_eps)$res-data$B)^2)),norm2=sqrt(sum((data$B-ols(data))^2))))
}


### Try with some normal data n=100, d=2, M=100.
dat3002 <- datagen(n=300,beta=c(56,24),rcdf=rnorm,meanX=c(73,3),sdX=c(6,9))


resnorm2 <- rbind.data.frame(c(0.001905935,0.004470913),c(0.001636345,0.00640783),c(0.005784043,0.002840163),c(0.002688907,0.005384342), c(0.01822553, 0.01053502),
                             c(0.01410006, 0.01185256),
                             c(0.01882739, 0.01005102),
                             c(0.0007585612, 0.001976087),
                             c(0.005697254, 0.006291956),
                             c(0.005660192, 0.0004130684),
                             c(0.009198206, 0.006927396),
                             c(0.002945106, 0.00265141),
                             c(0.006249235, 0.004442567),
                             c(0.01850845, 0.01476911),
                             c(0.008159696, 0.006109528),
                             c(0.003800188, 0.00216723),
                             c(0.002785486, 0.001754386),
                             c(0.008389293, 0.009647752),
                             c(0.007573341, 0.001676371),
                             c(0.01544865, 0.01125848),
                             c(0.0006719381, 0.001226978),
                             c(0.002516303, 0.006750943),
                             c(0.0004237654, 0.0003518504),
                             c(0.003702847, 0.001534467),
                             c(0.01122338, 0.007266418),
                             c(0.007709492, 0.001035513),
                             c(0.004356393, 0.002866829),
                             c(0.01060801, 0.006942939),
                             c(0.00912828, 0.009971081),
                             c(0.002280643, 0.002528349),
                             c(0.005067104, 0.006927193),
                             c(0.002581101, 0.001120816),
                             c(0.001018533, 0.004043615),
                             c(0.005976878, 0.004751448),
                             c(0.005204949, 0.001726402),
                             c(0.00717476, 0.005159627),
                             c(0.004274612, 0.003628541),
                             c(0.005128048, 0.001380665),
                             c(0.007856098, 0.002420933),
                             c(0.002786205, 0.003183972),
                             c(0.006570302, 0.007668212),
                             c(0.003923116, 0.004083226),
                             c(0.01141721, 0.006421517),
                             c(0.004885008, 0.005577291),
                             c(0.01611176, 0.01269206),
                             c(0.000245558, 0.00223388),
                             c(0.0002054096, 0.0003749879),
                             c(0.005058982, 0.001051182),
                             c(0.005410008, 0.001434709),
                             c(0.002709056, 0.006085548),
                             c(0.01519676, 0.01169296),
                             c(0.0129459, 0.007655336),
                             c(0.003934612, 0.001961566),
                             c(0.01136902, 0.008860779),
                             c(0.002317018, 0.006311938),
                             c(0.01074791, 0.008532097),
                             c(0.007644849, 0.004504915),
                             c(0.0133842, 0.01213863),
                             c(0.004418081, 0.001063851),
                             c(0.001605174, 0.002100443),
                             c(0.002635823, 0.003115765),
                             c(0.01709572, 0.004976028),
                             c(0.006418776, 0.001347629),
                             c(0.002602473, 0.003280166),
                             c(0.009530886, 0.004290848),
                             c(0.005495684, 0.006612257),
                             c(0.005453274, 0.004128688),
                             c(0.002749144, 0.002186654),
                             c(0.004626127, 0.003463054),
                             c(0.0003597979, 0.0007627089),
                             c(0.01138296, 0.003129192),
                             c(0.00452074, 0.002668815),
                             c(0.008241767, 0.009277847),
                             c(0.008042171, 0.005447631),
                             c(0.006995262, 0.008557352),
                             c(0.01370003, 0.003774452),
                             c(0.02432776, 0.01880747),
                             c(0.0039574, 0.003622039),
                             c(0.01062625, 0.007035312),
                             c(0.005938814, 0.01017326),
                             c(0.005444667, 0.006091348),
                             c(0.008497494, 0.005214008),
                             c(0.0107948, 0.008888919),
                             c(0.01078378, 0.00233417),
                             c(0.001680518, 0.002467532),
                             c(0.01401289, 0.006305392),
                             c(0.003934092, 0.0004635519),
                             c(0.008355393, 0.001770047),
                             c(0.007760804, 0.001889949),
                             c(0.006209847, 0.006463926),
                             c(0.004587531, 0.005292405),
                             c(0.0006667382, 0.003933235),
                             c(0.005906353, 0.003495322),
                             c(0.002046011, 0.002871144),
                             c(0.003325945, 0.0005319973),
                             c(0.00495594, 0.003628972),
                             c(0.003167455, 0.001096323),
                             c(0.00490793, 0.002871439),
                             c(0.00853842, 0.005703121),
                             c(0.001786713, 0.001381928))

colnames(resnorm2) <- c("norm1","norm2")
boxplot(resnorm2)
apply(resnorm2,2,mean)



### Try with some Laplace error data n=100, d=2, M=100.
datplace <- datagen(100, c(3.75,-19.67), rlaplace, c(84,9.43), c(1,5.6), M=100)

resnorm3 <- rbind.data.frame(c(0.001127050,0.030959201), c(0.012099386,0.017935866), c(0.010077054, 0.009032522), c(0.016543574,0.028432522), c(0.016066112,0.008910837),c(0.015715095,0.012189138), c(0.004307941,0.019218697), c(0.023790995,0.026876463), c(0.048128149, 0.034620321), c(0.004525511,0.013269262), 
                             c(0.010469686,0.022122284), c(0.003991318,0.024681306), c(0.020022762,0.034944273), c(0.014682117,0.004730379), c(0.028471299,0.046102096), c(0.013781947,0.002269873), c(0.034217969,0.003914754), c(0.012581562, 0.037952953),c(0.005927549,0.021476754), c(0.030547819, 0.008458943), c(0.036665383,0.034574315), c(0.010482194, 0.030242703), c(0.023128311,0.028721276), c(0.019791434, 0.009035704), c(0.004233087,0.006000467), c(0.017558171, 0.001233241), c(0.010434942,0.009691387), c(0.010288326,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               0.012806780), c(0.016094977,0.016076670), c(0.010552702, 0.002409486), c(0.013761351,0.001966138), c(0.002739614,0.015014501), c(0.033461841,0.015158370), c(0.010159829, 0.018987564),c(0.01057724, 0.01184081),
                             c(0.0319893, 0.01875731),
                             c(0.01114713, 0.02739141),
                             c(0.01817401, 0.02487349),
                             c(0.01040886, 0.0440562),
                             c(0.01122637, 0.02535624),
                             c(0.0155146, 0.0004742242),
                             c(0.03088091, 0.03795826),
                             c(0.03819464, 0.00223541),
                             c(0.02194388, 0.002477102),
                             c(0.01575755, 0.006874655),
                             c(0.002470057, 0.01806748),
                             c(0.01858109, 0.02420825),
                             c(0.005694305, 0.02703096),
                             c(0.004064729, 0.007628971),
                             c(0.008480176, 0.004141163),
                             c(0.01930725, 0.01650803),
                             c(0.004305645, 0.004590014),
                             c(0.02502174, 0.0006920111),
                             c(0.008841065, 0.02666301),
                             c(0.00886448, 0.01847074),
                             c(0.02849027, 0.02518573),
                             c(0.02022723, 0.00430526),
                             c(0.007635295, 0.03677229),
                             c(0.0192534, 0.02702058),
                             c(0.01399088, 0.001715245),
                             c(0.01903272, 0.003599678),
                             c(0.01741004, 0.008715459),
                             c(0.01631573, 0.008784087),
                             c(0.01367622, 0.0239135),
                             c(0.02633081, 0.01355851),
                             c(0.03486645, 0.03022588),
                             c(0.01446579, 0.01480844),
                             c(0.000989861, 0.002345455),
                             c(0.01773304, 0.03088062),
                             c(0.04330961, 0.01836198),
                             c(0.01616808, 0.03186328),
                             c(0.01155099, 0.02049664),
                             c(0.0361139, 0.024788),
                             c(0.03546737, 0.04714327),
                             c(0.02059918, 0.03804992),
                             c(0.01315778, 0.001993587),
                             c(0.001659515, 0.0103468),c(0.009798851, 0.01090041),c(0.01708057,0.01188683),
                             c(0.007021828, 0.005921606),
                             c(0.0457544, 0.03201109),
                             c(0.00210914, 0.01160287),
                             c(0.0002875773, 0.001652565),
                             c(0.006343772, 0.002578898),
                             c(0.03436705, 0.02700826),
                             c(0.02435737, 0.008740134),
                             c(0.02626688, 0.03405602),
                             c(0.04038426, 0.04148744),
                             c(0.008275688, 0.002782232),
                             c(0.005476374, 0.0007458375),
                             c(0.01061014, 0.01541988),
                             c(0.004500585, 0.007472157), c(0.03975384,0.05693525), c(0.002176253,0.01519044),c(0.006252824, 0.01233973),
                             c(0.03459483,0.05090479),c(0.02285277,0.0050182),c(0.004916381, 0.03061303),
                             c(0.01511801, 0.007951541), c(0.07220825,0.06530007))
colnames(resnorm3) <- c("norm1","norm2")
boxplot(resnorm3)
apply(resnorm3,2,mean)

### Try with some Laplace error data n=100, d=2, M=100.

datplace <- datagen(100, c(3.75,-19.67), rlaplace, c(84,9.43), c(1,5.6), M=100)

resnorm4 <- rbind.data.frame(
  c(0.05111186, 0.04680231),
  c(0.05546055, 0.04327569),
  c(0.1082039, 0.1191614),
  c(0.1146392, 0.1108818),
  c(0.0643387, 0.06067655),
  c(0.09269578, 0.08280338),
  c(0.1175907, 0.1297338),
  c(0.01640266, 0.002636073),
  c(0.06435264, 0.08288086),
  c(0.03478153, 0.01788994),
  c(0.1324867, 0.1447594),
  c(0.08259708, 0.07259671),
  c(0.0858877, 0.1022048),
  c(0.07849933, 0.07071994),
  c(0.04781907, 0.04309452),
  c(0.03898628, 0.02135951),
  c(0.0718607, 0.07051657),
  c(0.04062732, 0.01983729),
  c(0.1643698, 0.183565),
  c(0.03073538, 0.03852621),
  c(0.01376509, 0.005619),
  c(0.0221865, 0.04023925),
  c(0.05108089, 0.04310376),
  c(0.1087843, 0.090379),
  c(0.07738534, 0.05508705),
  c(0.1277732, 0.119936),
  c(0.126649, 0.1298829),
  c(0.06956559, 0.09370402),
  c(0.0287026, 0.01005081),
  c(0.07647934, 0.06644146),
  c(0.03628854, 0.04871112),
  c(0.004830913, 0.01534774),
  c(0.0929243, 0.08079616),
  c(0.1215977, 0.1363231),
  c(0.02051759, 0.005977671),
  c(0.1186987, 0.09338973),
  c(0.007699787, 0.003231259),
  c(0.1306908, 0.1141191),
  c(0.08705727, 0.07437524),
  c(0.04533361, 0.04943719),
  c(0.07493178, 0.08394354),
  c(0.09544936, 0.08618567),
  c(0.006760684, 0.006887993),
  c(0.06718681, 0.05986169),
  c(0.04038765, 0.05975285),
  c(0.1469201, 0.1412427),
  c(0.1492944, 0.134655),
  c(0.009297306, 0.02319693),
  c(0.07133477, 0.09610383),
  c(0.06463476, 0.08681788),
  c(0.1162047, 0.09726897),
  c(0.08077676, 0.05625851),
  c(0.1137491, 0.1199582),
  c(0.01471831, 0.01981294),
  c(0.03426844, 0.04276199),
  c(0.07729717, 0.08052022),
  c(0.129621, 0.1259662),
  c(0.06147145, 0.04291049),
  c(0.06495732, 0.06916687),
  c(0.0372546, 0.05793195),
  c(0.07121836, 0.08863148),
  c(0.04431845, 0.02074602),
  c(0.1104084, 0.1158431),
  c(0.002566167, 0.01273928),
  c(0.1389851, 0.1534093),
  c(0.08567983, 0.087985),c(0.01461773, 0.01480844),
  c(0.001350866, 0.002345455),
  c(0.03076712, 0.03088062),
  c(0.01913813, 0.01836198),
  c(0.03160015, 0.03186328),
  c(0.02038545, 0.02049664),
  c(0.02491281, 0.024788),
  c(0.0470246, 0.04714327),
  c(0.03790951, 0.03804992),
  c(0.002877795, 0.001993587),
  c(0.009687025, 0.0103468),
  c(0.01053187, 0.01090041),
  c(0.01137686, 0.01188683),
  c(0.005993503, 0.005921606),
  c(0.03304755, 0.03201109),
  c(0.01138337, 0.01160287),
  c(0.001428612, 0.001652565),
  c(0.002080854, 0.002578898),
  c(0.02699803, 0.02700826),
  c(0.008861491, 0.008740134),
  c(0.03386988, 0.03405602),
  c(0.04147311, 0.04148744),
  c(0.002615486, 0.002782232),
  c(0.0009562942, 0.0007458375),
  c(0.01506886, 0.01541988),
  c(0.007107717, 0.007472157),
  c(0.05570994, 0.05693525),
  c(0.0152226, 0.01519044),
  c(0.01194134, 0.01233973),
  c(0.05037274, 0.05090479),
  c(0.005264091, 0.0050182),
  c(0.0301572, 0.03061303),
  c(0.008194154, 0.007951541),
  c(0.06576941, 0.06530007)
)

resnorm2 <- list()
for (i in 1:100) {
  resnorm2[[i]] <- normbeta(datplace[[i+66]],plaplace,dlaplace)
  print(i)
}
colnames(resnorm4) <- c("norm1","norm2")
boxplot(resnorm4)
apply(resnorm4,2,mean)


### Try with some Normal error data n=500, d=3, M=100.

Simulation with 100 replications of a data set with 500 observations, 3 predicators (X1,X2,X3 normally distributed respectively with N(2,1), N(1.35,2.15), N(0.75,3)), true beta of (-0.67,2.6,1) and errors distributed according to a Normal(0,2).


datnorm3D <- datagen(500, c(-0.67,2.6,1), function(x) rnorm(x, mean=0, sd=2), c(2,1.35,0.75), c(1,2.15,3), M=100)

resnorm5 <- list()
for (i in 1:100) {
  resnorm5[[i]] <- normbeta(datnorm3D[[i]],function(x) pnorm(x, mean=0, sd=2),function(x) dnorm(x, mean=0, sd=2))
  print(i)
}

unlist(resnorm5)
resnorm5 <- matrix(resnorm5,ncol=2,nrow=100,byrow=TRUE)

colnames(resnorm5) <- c("norm1","norm2")
boxplot(resnorm5)
apply(resnorm5,2,mean)



datnorm3Dxl <- datagen(1500, c(-0.67,2.6,1), function(x) rnorm(x, mean=0, sd=2), c(2,1.35,0.75), c(1,2.15,3), M=100)

resnorm6 <- list()
for (i in 1:100) {
  resnorm6[[i]] <- normbeta(datnorm3Dxl[[i]],function(x) pnorm(x, mean=0, sd=2),function(x) dnorm(x, mean=0, sd=2))
  print(i)
}

resnorm6 <- rbind(c(0.070450915, 0.070617698),
                  c(0.044950673, 0.043662979),
                  c(0.069510395, 0.071348927),
                  c(0.076216496, 0.076508119),
                  c(0.049271327, 0.050018346),
                  c(0.052882394, 0.052759235),
                  c(0.063686165, 0.063566470),
                  c(0.033547120, 0.032720637),
                  c(0.092643470, 0.092534393),
                  c(0.035530149, 0.035936690),
                  c(0.093318881, 0.092182868),
                  c(0.061149675, 0.059974435),
                  c(0.075533468, 0.075883484),
                  c(0.059120543, 0.058878725),
                  c(0.051969924, 0.050871842),
                  c(0.070363991, 0.070038328),
                  c(0.040531328, 0.039574846),
                  c(0.050436721, 0.051724075),
                  c(0.034923232, 0.034379716),
                  c(0.046974180, 0.047104659),
                  c(0.058316137, 0.056911255),
                  c(0.032763121, 0.032839064),
                  c(0.090695188, 0.091931947),
                  c(0.044271565, 0.043695157),
                  c(0.033513386, 0.033774281),
                  c(0.036456963, 0.037055031),
                  c(0.088288337, 0.088717360),
                  c(0.045437731, 0.043953227),
                  c(0.073476593, 0.074940647),
                  c(0.163334901, 0.161995775),
                  c(0.060971150, 0.062249163),
                  c(0.058735016, 0.059555628),
                  c(0.065803007, 0.066067396),
                  c(0.050521273, 0.048786734),
                  c(0.117013443, 0.115451986),
                  c(0.031653380, 0.030070644),
                  c(0.037467749, 0.036582233),
                  c(0.059346260, 0.058393446),
                  c(0.097917866, 0.097309789),
                  c(0.031470604, 0.031759756),
                  c(0.061461301, 0.061382482),
                  c(0.051545240, 0.051802376),
                  c(0.029122345, 0.029289674),
                  c(0.042390441, 0.042604202),
                  c(0.022388615, 0.023897739),
                  c(0.039893741, 0.039336821),
                  c(0.076348131, 0.076846196),
                  c(0.047066092, 0.047593834),
                  c(0.095440873, 0.096069511),
                  c(0.126311865, 0.125885836),
                  c(0.014844703, 0.013985774),
                  c(0.079949621, 0.080280734),
                  c(0.077265802, 0.077721614),
                  c(0.079340787, 0.078851405),
                  c(0.082191703, 0.081531149),
                  c(0.060485322, 0.060477171),
                  c(0.007616459, 0.008578096),
                  c(0.038103731, 0.037398678),
                  c(0.053392942, 0.054063133),
                  c(0.049266005, 0.048381806),
                  c(0.043718378, 0.043946150),
                  c(0.062802605, 0.062558855),
                  c(0.031960174, 0.032235594),
                  c(0.028559313, 0.029337462),
                  c(0.066366319, 0.066269725),
                  c(0.076796032, 0.076155796),
                  c(0.062237296, 0.060632666),
                  c(0.079222138, 0.079177303),
                  c(0.033147628, 0.033909183),
                  c(0.049395561, 0.049153106),
                  c(0.104823007, 0.105588091),
                  c(0.039448674, 0.039992359),
                  c(0.028479356, 0.027792375),
                  c(0.103540174, 0.104231646),
                  c(0.066271489, 0.067185700),
                  c(0.079796091, 0.080318495),
                  c(0.030014858, 0.030709867),
                  c(0.040913048, 0.041285954),
                  c(0.058548029, 0.057365161),
                  c(0.032738499, 0.032204241),
                  c(0.146682262, 0.145803358),
                  c(0.088232124, 0.087513974),
                  c(0.081907418, 0.081007714),
                  c(0.095318879, 0.094455137),
                  c(0.084923010, 0.084912823),
                  c(0.101037879, 0.100827496),
                  c(0.094656815, 0.094101709),
                  c(0.046590362, 0.046447967)


